<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>FH Admin</title>
		<!-- HTML5 Shim and Respond.js IE10 support of HTML5 elements and media queries -->
		<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
		<!--[if lt IE 10]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
		<![endif]-->
		<!-- Meta -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="author" content="FH Admin QQ313596790" />

		<link rel="icon" href="../../../assets/images/favicon.ico" type="image/x-icon">
		<link rel="stylesheet" href="../../../assets/fonts/fontawesome/css/fontawesome-all.min.css">
		<link rel="stylesheet" href="../../../assets/plugins/animation/css/animate.min.css">
		<link rel="stylesheet" href="../../../assets/css/style.css">

		<!-- 日期插件 -->
		<link rel="stylesheet"
			href="../../../assets/plugins/material-datetimepicker/css/bootstrap-material-datetimepicker.css">

		<!-- select插件 -->
		<link rel="stylesheet" href="../../../assets/plugins/select2/css/select2.min.css">
		<link rel="stylesheet" href="../../../assets/plugins/multi-select/css/multi-select.css">

		<!-- vue -->
		<script src="../../../assets/js-vue/vue.js"></script>
		<!--全局配置-->
		<script src="../../../assets/js-v/config.js"></script>

		<style type="text/css">
			div.costs-uploadfile-div {
				position: relative;
				cursor: pointer;
				margin-left: 2px;
			}

			div.costs-uploadfile-div #DOCTOR_PHOTO {
				width: 505px;
				height: 100%;
				cursor: pointer;
			}

			div.costs-uploadfile-div #SOURCE {
				width: 505px;
				height: 100%;
				position: absolute;
				top: 0;
				left: 0;
				filter: alpha(opacity:0);
				opacity: 0;
				cursor: pointer;
			}

			#DOCTOR_PHOTO {
				width: 100%;
				height: 100%;
				object-fit: contain;
			}
		</style>
	</head>

	<body style="background-color: white">

		<!-- [加载状态 ] start -->
		<div class="loader-bg">
			<div class="loader-track">
				<div class="loader-fill"></div>
			</div>
		</div>
		<!-- [ 加载状态  ] End -->

		<!-- [ 主内容区 ] start -->
		<div class="pcoded-wrapper" id="app">
			<div class="pcoded-content">
				<div class="pcoded-inner-content">
					<div class="main-body">
						<div class="page-wrapper">
							<!-- [ Main Content ] start -->
							<div class="row">

								<div style="width: 100%;">
									<div id="showform">
										<div class="input-group input-group-sm mb-3" style="margin-top: -10px;">
											<div class="input-group-prepend">
												<span class="input-group-text" style="width: 79px;"><span
														style="width: 100%;">姓名</span></span>
											</div>
											<input type="text" class="form-control" ref="DOCTOR_NAME" id="DOCTOR_NAME"
												v-model="pd.DOCTOR_NAME" maxlength="255" placeholder="这里输入姓名"
												title="姓名">
										</div>
										<div class="input-group input-group-sm mb-3" style="margin-top: -10px;">
											<div class="input-group-prepend">
												<span class="input-group-text" style="width: 79px;"><span
														style="width: 100%;">账号</span></span>
											</div>
											<input type="text" class="form-control" ref="DOCTOR_ACCOUNT"
												id="DOCTOR_ACCOUNT" v-model="pd.DOCTOR_ACCOUNT" maxlength="255"
												placeholder="这里输入账号" title="账号">
										</div>
										<div class="input-group input-group-sm mb-3" style="margin-top: -10px;">
											<div class="input-group-prepend">
												<span class="input-group-text" style="width: 79px;"><span
														style="width: 100%;">密码</span></span>
											</div>
											<input type="text" class="form-control" ref="DOCTOR_PASSWORD"
												id="DOCTOR_PASSWORD" v-model="pd.DOCTOR_PASSWORD" maxlength="255"
												placeholder="这里输入密码" title="密码">
										</div>
										<div class="input-group input-group-sm mb-3" style="margin-top: -10px;">
											<div class="input-group-prepend">
												<span class="input-group-text" style="width: 79px;"><span
														style="width: 100%;">年龄</span></span>
											</div>
											<input type="text" class="form-control" ref="DOCTOR_AGE" id="DOCTOR_AGE"
												v-model="pd.DOCTOR_AGE" maxlength="255" placeholder="这里输入年龄" title="年龄">
										</div>
										<div class="input-group input-group-sm mb-3" style="margin-top: -10px;">
											<div class="input-group-prepend">
												<span class="input-group-text" style="width: 79px;"><span
														style="width: 100%;">简介</span></span>
											</div>
											<input type="text" class="form-control" ref="DOCTOR_INFO" id="DOCTOR_INFO"
												v-model="pd.DOCTOR_INFO" maxlength="255" placeholder="这里输入简介"
												title="简介">
										</div>
										<div class="input-group input-group-sm mb-3" style="margin-top: -10px;">
											<div class="input-group-prepend">
												<span class="input-group-text" style="width: 79px;"><span
														style="width: 100%;">费用</span></span>
											</div>
											<input type="text" class="form-control" ref="DOCTOR_COST" id="DOCTOR_COST"
												v-model="pd.DOCTOR_COST" maxlength="255" placeholder="这里输入费用"
												title="费用">
										</div>

										<div class="input-group input-group-sm mb-3" style="margin-top: -10px;">
											<div class="input-group-prepend">
												<span class="input-group-text" style="width: 79px;"><span
														style="width: 100%;">照片</span></span>
											</div>
											<div class="costs-uploadfile-div">
												<input type="file" id="SOURCE" ref="SOURCE" @change="upload" />
												<div style="width: 300px;height: 200px;">
													<img :src="pd.DOCTOR_PHOTO" ref="DOCTOR_PHOTO" id="DOCTOR_PHOTO">
												</div>
											</div>
										</div>

										<div class="input-group input-group-sm mb-3" style="margin-top: -10px;">
											<div class="input-group-prepend">
												<span class="input-group-text" style="width: 79px;"><span
														style="width: 100%;">职称</span></span>
											</div>
											<input type="text" class="form-control" ref="DOCTOR_TITLE" id="DOCTOR_TITLE"
												v-model="pd.DOCTOR_TITLE" maxlength="255" placeholder="这里输入职称"
												title="职称">
										</div>
										<div class="input-group input-group-sm mb-3" style="margin-top: -10px;">
											<div class="input-group-prepend">
												<span class="input-group-text" style="width: 79px;"><span
														style="width: 100%;">服务名称</span></span>
											</div>
											<input type="text" class="form-control" ref="DOCTOR_SERVER" id="DOCTOR_SERVER"
												   v-model="pd.DOCTOR_SERVER" maxlength="255" placeholder="这里输入职称"
												   title="职称">
										</div>
										<div class="input-group" style="margin-top:10px;background-color: white">
											<span style="width: 100%;text-align: center;">
												<a class="btn btn-light btn-sm" v-on:click="save">保存</a>
												<a class="btn btn-light btn-sm" onclick="top.Dialog.close()">取消</a>
											</span>
										</div>
									</div>
									<!-- [加载状态 ] start -->
									<div id="jiazai" style="display:none;margin-top:50px;">
										<div class="d-flex justify-content-center">
											<div class="spinner-border" style="width: 3rem; height: 3rem;"
												role="status">
												<span class="sr-only">Loading...</span>
											</div>
										</div>
									</div>
									<!-- [ 加载状态  ] End -->
								</div>

							</div>
							<!-- [ Main Content ] end -->
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- [ 主内容区 ] end -->

		<script type="text/javascript" src="../../../assets/js/jquery-1.7.2.js"></script>
		<script type="text/javascript" src="../../../assets/js/pre-loader.js"></script>
		<script src="../../../assets/plugins/sweetalert/js/sweetalert.min.js"></script>

		<!-- 日期插件 -->
		<script src="../../../assets/js/pages/moment-with-locales.min.js"></script>
		<script src="../../../assets/plugins/material-datetimepicker/js/bootstrap-material-datetimepicker.js"></script>
		<script src="../../../assets/js/pages/form-picker-custom.js"></script>

		<!-- select插件 -->
		<script src="../../../assets/plugins/select2/js/select2.full.min.js"></script>
		<script src="../../../assets/plugins/multi-select/js/jquery.quicksearch.js"></script>
		<script src="../../../assets/plugins/multi-select/js/jquery.multi-select.js"></script>
		<script src="../../../assets/js/pages/form-select-custom.js"></script>

		<!-- 表单验证提示 -->
		<script src="../../../assets/js/jquery.tips.js"></script>

		<script type="text/javascript">
			var vm = new Vue({
				el: '#app',

				data: {
					HTTPURL: httpurl,
					DOCTOR_ID: '', //主键ID
					pd: {
						DOCTOR_PHOTO: ""
					}, //存放字段参数
					msg: 'add',
					fileContent: '',
					OLD_DOCTOR_PHOTO: ''
				},

				methods: {
					//初始执行
					init() {
						var FID = this.getUrlKey('FID'); //当接收过来的FID不为null时,表示此页面是修改进来的
						if (null != FID) {
							this.msg = 'edit';
							this.DOCTOR_ID = FID;
							this.getData();
						}
						setTimeout(function() {
							vm.getDict();
						}, 200);
					},

					upload: function(e) {
						let file = this.$refs.SOURCE.files[0];
						this.fileContent = file;
						let fileType = file.type.split("/")[1];
						if (fileType != 'png' && fileType != 'jpg' && fileType != 'jpeg') {
							$("#SOURCE").tips({
								side: 3,
								msg: '请上传图片格式的文件',
								bg: '#AE81FF',
								time: 3
							});
							$("#SOURCE").val('');
							this.pd.DOCTOR_PHOTO = '';
							file = '请选择图片';
							this.fileContent = '';
						} else {
							let img_src = URL.createObjectURL(file);
							$("#DOCTOR_PHOTO").attr("src"," ")
							console.log(img_src);
							this.pd.DOCTOR_PHOTO = img_src;
						}
					},

					//去保存
					save: function() {
						if (this.pd.DOCTOR_NAME == '' || this.pd.DOCTOR_NAME == undefined) {
							$("#DOCTOR_NAME").tips({
								side: 3,
								msg: '请输入姓名',
								bg: '#AE81FF',
								time: 2
							});
							this.pd.DOCTOR_NAME = '';
							this.$refs.DOCTOR_NAME.focus();
							return false;
						}
						if (this.pd.DOCTOR_ACCOUNT == '' || this.pd.DOCTOR_ACCOUNT == undefined) {
							$("#DOCTOR_ACCOUNT").tips({
								side: 3,
								msg: '请输入账号',
								bg: '#AE81FF',
								time: 2
							});
							this.pd.DOCTOR_ACCOUNT = '';
							this.$refs.DOCTOR_ACCOUNT.focus();
							return false;
						}
						if (this.pd.DOCTOR_PASSWORD == '' || this.pd.DOCTOR_PASSWORD == undefined) {
							$("#DOCTOR_PASSWORD").tips({
								side: 3,
								msg: '请输入密码',
								bg: '#AE81FF',
								time: 2
							});
							this.pd.DOCTOR_PASSWORD = '';
							this.$refs.DOCTOR_PASSWORD.focus();
							return false;
						}
						if (this.pd.DOCTOR_AGE == '' || this.pd.DOCTOR_AGE == undefined) {
							$("#DOCTOR_AGE").tips({
								side: 3,
								msg: '请输入年龄',
								bg: '#AE81FF',
								time: 2
							});
							this.pd.DOCTOR_AGE = '';
							this.$refs.DOCTOR_AGE.focus();
							return false;
						}
						if (this.pd.DOCTOR_INFO == '' || this.pd.DOCTOR_INFO == undefined) {
							$("#DOCTOR_INFO").tips({
								side: 3,
								msg: '请输入简介',
								bg: '#AE81FF',
								time: 2
							});
							this.pd.DOCTOR_INFO = '';
							this.$refs.DOCTOR_INFO.focus();
							return false;
						}
						if (this.pd.DOCTOR_COST == '' || this.pd.DOCTOR_COST == undefined) {
							$("#DOCTOR_COST").tips({
								side: 3,
								msg: '请输入费用',
								bg: '#AE81FF',
								time: 2
							});
							this.pd.DOCTOR_COST = '';
							this.$refs.DOCTOR_COST.focus();
							return false;
						}

						if (this.pd.DOCTOR_PHOTO == '' || this.pd.DOCTOR_PHOTO == undefined) {
							$("#DOCTOR_PHOTO").tips({
								side: 3,
								msg: '请上传照片',
								bg: '#AE81FF',
								time: 2
							});
							this.pd.DOCTOR_PHOTO = '';
							this.$refs.DOCTOR_PHOTO.focus();
							return false;
						}

						if (this.pd.DOCTOR_TITLE == '' || this.pd.DOCTOR_TITLE == undefined) {
							$("#DOCTOR_TITLE").tips({
								side: 3,
								msg: '请输入职称',
								bg: '#AE81FF',
								time: 2
							});
							this.pd.DOCTOR_TITLE = '';
							this.$refs.DOCTOR_TITLE.focus();
							return false;
						}
						if (this.pd.DOCTOR_SERVER == '' || this.pd.DOCTOR_SERVER == undefined) {
							$("#DOCTOR_SERVER").tips({
								side: 3,
								msg: '请输入服务名称',
								bg: '#AE81FF',
								time: 2
							});
							this.pd.DOCTOR_SERVER = '';
							this.$refs.DOCTOR_SERVER.focus();
							return false;
						}

						$("#showform").hide();
						$("#jiazai").show();

						//发送 post 请求提交保存
						if (0 != this.pd.length && this.pd.DOCTOR_PHOTO.indexOf("blob") == -1) {
							//当图片未重新上传时
							$.ajax({
								xhrFields: {
									withCredentials: true
								},
								type: "POST",
								url: httpurl + 'doctor/' + this.msg,
								data: {
									DOCTOR_ID: this.DOCTOR_ID,
									DOCTOR_NAME: this.pd.DOCTOR_NAME,
									DOCTOR_ACCOUNT: this.pd.DOCTOR_ACCOUNT,
									DOCTOR_PASSWORD: this.pd.DOCTOR_PASSWORD,
									DOCTOR_AGE: this.pd.DOCTOR_AGE,
									DOCTOR_INFO: this.pd.DOCTOR_INFO,
									DOCTOR_COST: this.pd.DOCTOR_COST,
									DOCTOR_PHOTO: this.OLD_DOCTOR_PHOTO,
									DOCTOR_TITLE: this.pd.DOCTOR_TITLE,
									DOCTOR_SERVER: this.pd.DOCTOR_SERVER,
									tm: new Date().getTime()
								},
								dataType: "json",
								success: function(data) {
									if ("success" == data.result) {
										swal("", "保存成功", "success");
										setTimeout(function() {
											top.Dialog.close(); //关闭弹窗
										}, 1000);
									} else if ("exception" == data.result) {
										showException("医生管理", data.exception); //显示异常
										$("#showform").show();
										$("#jiazai").hide();
									}
								}
							}).done().fail(function() {
								swal("登录失效!", "请求服务器无响应，稍后再试", "warning");
								$("#showform").show();
								$("#jiazai").hide();
							});
						} else {
							console.log("修改图片");
							var todata = new FormData();
							todata.append("DOCTOR_ID", this.DOCTOR_ID);
							todata.append("DOCTOR_NAME", this.pd.DOCTOR_NAME);
							todata.append("DOCTOR_ACCOUNT", this.pd.DOCTOR_ACCOUNT);
							todata.append("DOCTOR_PASSWORD", this.pd.DOCTOR_PASSWORD);
							todata.append("DOCTOR_AGE", this.pd.DOCTOR_AGE);
							todata.append("DOCTOR_INFO", this.pd.DOCTOR_INFO);
							todata.append("DOCTOR_COST", this.pd.DOCTOR_COST);
							todata.append("fileContent", this.fileContent);
							todata.append("DOCTOR_TITLE", this.pd.DOCTOR_TITLE);
							todata.append("DOCTOR_SERVER", this.pd.DOCTOR_SERVER);
							todata.append("OLD_DOCTOR_PHOTO", this.OLD_DOCTOR_PHOTO);
							todata.append("tm", new Date().getTime());
							$.ajax({
								xhrFields: {
									withCredentials: true
								},
								type: "POST",
								url: httpurl + 'doctor/' + this.msg,
								data: todata,
								async: false,
								cache: false,
								contentType: false,
								processData: false,
								success: function(data) {
									if ("success" == data.result) {
										swal("", "保存成功", "success");
										setTimeout(function() {
											top.Dialog.close(); //关闭弹窗
										}, 1000);
									} else if ("exception" == data.result) {
										showException("医生管理", data.exception); //显示异常
										$("#showform").show();
										$("#jiazai").hide();
									}
								}
							}).done().fail(function() {
								swal("登录失效!", "请求服务器无响应，稍后再试", "warning");
								$("#showform").show();
								$("#jiazai").hide();
							});

						}

					},

					//根据主键ID获取数据
					getData: function() {
						//发送 post 请求
						$.ajax({
							xhrFields: {
								withCredentials: true
							},
							type: "POST",
							url: httpurl + 'doctor/goEdit',
							data: {
								DOCTOR_ID: this.DOCTOR_ID,
								tm: new Date().getTime()
							},
							dataType: "json",
							success: function(data) {
								if ("success" == data.result) {
									vm.OLD_DOCTOR_PHOTO = data.pd.DOCTOR_PHOTO;
									data.pd.DOCTOR_PHOTO = '/'+data.pd.DOCTOR_PHOTO;
									
									vm.pd = data.pd; //参数map
								} else if ("exception" == data.result) {
									showException("医生管理", data.exception); //显示异常
									$("#showform").show();
									$("#jiazai").hide();
								}
							}
						}).done().fail(function() {
							swal("登录失效!", "请求服务器无响应，稍后再试", "warning");
							$("#showform").show();
							$("#jiazai").hide();
						});
					},

					//获取数据字典数据
					getDict: function() {},

					//根据url参数名称获取参数值
					getUrlKey: function(name) {
						return decodeURIComponent(
							(new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.href) || [,
								""
							])[1].replace(/\+/g, '%20')) || null;
					}

				},

				mounted() {
					this.init();
				}
			})
		</script>

	</body>
</html>
